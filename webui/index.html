<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Neuro-Lite AI</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f0f17;--surface:#1a1a2e;--surface2:#16213e;--border:#2a2a4a;
  --text:#e0e0e0;--text-muted:#888;--accent:#4fc3f7;--accent2:#7c4dff;
  --user-bg:#1e3a5f;--bot-bg:#1e1e30;--danger:#ef5350;--success:#66bb6a;
}
html,body{height:100%;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}
#app{display:flex;flex-direction:column;height:100vh;max-width:860px;margin:0 auto}
/* Header */
.header{padding:14px 20px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0}
.header .logo{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;color:#fff}
.header h1{font-size:18px;font-weight:600}
.header .status{margin-left:auto;font-size:12px;color:var(--text-muted);display:flex;align-items:center;gap:6px}
.header .status .dot{width:8px;height:8px;border-radius:50%;background:var(--success)}
.header .status .dot.off{background:var(--danger)}
/* Chat */
.chat-area{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px;scroll-behavior:smooth}
.msg{display:flex;gap:10px;max-width:88%;animation:fadeIn .3s ease}
.msg.user{margin-left:auto;flex-direction:row-reverse}
.msg .avatar{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600}
.msg.user .avatar{background:var(--accent);color:#000}
.msg.bot .avatar{background:var(--accent2);color:#fff}
.msg .bubble{padding:12px 16px;border-radius:16px;line-height:1.6;font-size:14.5px;word-wrap:break-word;overflow-wrap:break-word}
.msg.user .bubble{background:var(--user-bg);border-bottom-right-radius:4px}
.msg.bot .bubble{background:var(--bot-bg);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg.bot .bubble pre{background:#111;padding:10px;border-radius:6px;overflow-x:auto;margin:8px 0;font-size:13px}
.msg.bot .bubble code{background:#222;padding:2px 5px;border-radius:3px;font-size:13px;font-family:'Fira Code',monospace}
.msg.bot .bubble pre code{background:transparent;padding:0}
.msg.bot .bubble p{margin:6px 0}
.msg.bot .bubble ul,.msg.bot .bubble ol{margin:6px 0 6px 20px}
.msg.bot .bubble h1,.msg.bot .bubble h2,.msg.bot .bubble h3{margin:10px 0 4px;color:var(--accent)}
.msg.bot .bubble h1{font-size:18px} .msg.bot .bubble h2{font-size:16px} .msg.bot .bubble h3{font-size:15px}
.msg.bot .bubble strong{color:var(--accent)}
.msg.bot .bubble a{color:var(--accent);text-decoration:underline}
.typing{display:flex;gap:4px;padding:4px 0}
.typing span{width:7px;height:7px;border-radius:50%;background:var(--text-muted);animation:bounce 1.4s infinite}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
/* Input */
.input-area{padding:16px 20px;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0}
.input-wrap{display:flex;gap:10px;align-items:flex-end}
.input-wrap textarea{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px 16px;color:var(--text);font-size:14.5px;font-family:inherit;resize:none;outline:none;min-height:44px;max-height:150px;line-height:1.5;transition:border-color .2s}
.input-wrap textarea:focus{border-color:var(--accent)}
.input-wrap textarea::placeholder{color:var(--text-muted)}
.send-btn{width:44px;height:44px;border-radius:50%;border:none;background:var(--accent);color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s,transform .1s;flex-shrink:0}
.send-btn:hover{background:#29b6f6}
.send-btn:active{transform:scale(.93)}
.send-btn:disabled{opacity:.4;cursor:not-allowed}
.send-btn svg{width:20px;height:20px}
/* Emotion badge */
.emotion-badge{font-size:11px;padding:2px 8px;border-radius:10px;color:var(--bg);font-weight:600;margin-bottom:4px;display:inline-block}
.emotion-badge.concerned{background:#ffa726}
.emotion-badge.frustrated{background:#ef5350}
.emotion-badge.celebratory{background:#66bb6a}
.emotion-badge.grateful{background:#4fc3f7}
.emotion-badge.curious{background:#ab47bc}
/* Responsive */
@media(max-width:600px){
  #app{max-width:100%}
  .msg{max-width:94%}
  .header h1{font-size:16px}
}
/* Welcome */
.welcome{text-align:center;padding:40px 20px;color:var(--text-muted)}
.welcome h2{color:var(--text);font-size:22px;margin-bottom:8px}
.welcome p{font-size:14px;max-width:400px;margin:0 auto;line-height:1.6}
.suggestions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:20px}
.suggestions button{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:20px;cursor:pointer;font-size:13px;transition:border-color .2s}
.suggestions button:hover{border-color:var(--accent)}
</style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="logo">N</div>
    <h1>Neuro-Lite</h1>
    <div class="status"><div class="dot" id="statusDot"></div><span id="statusText">Connecting...</span></div>
  </div>
  <div class="chat-area" id="chatArea">
    <div class="welcome" id="welcome">
      <h2>Welcome to Neuro-Lite</h2>
      <p>Your private, empathetic AI assistant running locally on your hardware.</p>
      <div class="suggestions">
        <button onclick="sendSuggestion('Explain how DNS works')">Explain DNS</button>
        <button onclick="sendSuggestion('Write a Python function to sort a list')">Python sorting</button>
        <button onclick="sendSuggestion('What are best practices for data security?')">Data security</button>
        <button onclick="sendSuggestion('Help me debug a 503 error')">Debug 503</button>
      </div>
    </div>
  </div>
  <div class="input-area">
    <div class="input-wrap">
      <textarea id="msgInput" placeholder="Type your message..." rows="1" autofocus></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
(function(){
  const chatArea=document.getElementById('chatArea');
  const msgInput=document.getElementById('msgInput');
  const sendBtn=document.getElementById('sendBtn');
  const statusDot=document.getElementById('statusDot');
  const statusText=document.getElementById('statusText');
  const welcomeEl=document.getElementById('welcome');

  let sessionId=localStorage.getItem('nl_session')||'';
  let isGenerating=false;

  // Auto-resize textarea
  msgInput.addEventListener('input',function(){
    this.style.height='auto';
    this.style.height=Math.min(this.scrollHeight,150)+'px';
  });
  msgInput.addEventListener('keydown',function(e){
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
  });

  // Check server health
  async function checkHealth(){
    try{
      const r=await fetch('/health');
      const d=await r.json();
      if(d.model_loaded){statusDot.className='dot';statusText.textContent='Online';}
      else{statusDot.className='dot off';statusText.textContent='Model loading...';}
    }catch{statusDot.className='dot off';statusText.textContent='Offline';}
  }
  checkHealth();
  setInterval(checkHealth,30000);

  window.sendSuggestion=function(text){msgInput.value=text;sendMessage();};

  function scrollBottom(){chatArea.scrollTo({top:chatArea.scrollHeight,behavior:'smooth'});}

  function renderMarkdown(text){
    let html=text;
    // Code blocks
    html=html.replace(/```(\w*)\n([\s\S]*?)```/g,function(_,lang,code){
      return '<pre><code class="lang-'+lang+'">'+escHtml(code.trim())+'</code></pre>';
    });
    // Inline code
    html=html.replace(/`([^`\n]+)`/g,'<code>$1</code>');
    // Bold
    html=html.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
    // Italic
    html=html.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g,'<em>$1</em>');
    // Headers
    html=html.replace(/^### (.+)$/gm,'<h3>$1</h3>');
    html=html.replace(/^## (.+)$/gm,'<h2>$1</h2>');
    html=html.replace(/^# (.+)$/gm,'<h1>$1</h1>');
    // Unordered list
    html=html.replace(/^[\-\*] (.+)$/gm,'<li>$1</li>');
    html=html.replace(/((?:<li>.*<\/li>\n?)+)/g,'<ul>$1</ul>');
    // Ordered list
    html=html.replace(/^\d+\. (.+)$/gm,'<li>$1</li>');
    // Links
    html=html.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
    // Paragraphs
    html=html.replace(/\n{2,}/g,'</p><p>');
    html='<p>'+html+'</p>';
    html=html.replace(/<p><\/p>/g,'');
    // Line break
    html=html.replace(/\n/g,'<br>');
    return html;
  }

  function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

  function addMessage(role,content,emotion){
    if(welcomeEl)welcomeEl.remove();
    const div=document.createElement('div');
    div.className='msg '+role;
    const avatar=document.createElement('div');
    avatar.className='avatar';
    avatar.textContent=role==='user'?'U':'N';
    const bubble=document.createElement('div');
    bubble.className='bubble';
    if(role==='bot'){
      if(emotion&&emotion!=='neutral'){
        const badge=document.createElement('span');
        badge.className='emotion-badge '+emotion;
        badge.textContent=emotion;
        bubble.appendChild(badge);
        bubble.appendChild(document.createElement('br'));
      }
      bubble.innerHTML+= renderMarkdown(content);
    }else{
      bubble.textContent=content;
    }
    div.appendChild(avatar);
    div.appendChild(bubble);
    chatArea.appendChild(div);
    scrollBottom();
    return bubble;
  }

  function addTyping(){
    const div=document.createElement('div');
    div.className='msg bot';div.id='typing-indicator';
    div.innerHTML='<div class="avatar">N</div><div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>';
    chatArea.appendChild(div);
    scrollBottom();
  }
  function removeTyping(){const t=document.getElementById('typing-indicator');if(t)t.remove();}

  async function sendMessage(){
    if(isGenerating)return;
    const text=msgInput.value.trim();
    if(!text)return;
    msgInput.value='';
    msgInput.style.height='auto';
    addMessage('user',text);
    isGenerating=true;
    sendBtn.disabled=true;
    addTyping();

    try{
      const resp=await fetch('/chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({message:text,session_id:sessionId}),
      });

      if(!resp.ok){
        removeTyping();
        const err=await resp.json().catch(()=>({error:'Server error'}));
        addMessage('bot','Error: '+(err.error||resp.statusText));
        return;
      }

      removeTyping();
      let botBubble=null;
      let fullTokens='';
      let meta={};

      const reader=resp.body.getReader();
      const decoder=new TextDecoder();
      let buffer='';

      while(true){
        const{done,value}=await reader.read();
        if(done)break;
        buffer+=decoder.decode(value,{stream:true});
        const lines=buffer.split('\n');
        buffer=lines.pop()||'';
        for(const line of lines){
          if(!line.startsWith('data: '))continue;
          const jsonStr=line.slice(6).trim();
          if(!jsonStr)continue;
          try{
            const ev=JSON.parse(jsonStr);
            if(ev.type==='meta'){
              meta=ev;
              if(ev.session_id){sessionId=ev.session_id;localStorage.setItem('nl_session',sessionId);}
            }else if(ev.type==='token'){
              if(!botBubble){
                const div=document.createElement('div');
                div.className='msg bot';
                const avatar=document.createElement('div');
                avatar.className='avatar';avatar.textContent='N';
                const bubble=document.createElement('div');
                bubble.className='bubble';
                if(meta.emotion&&meta.emotion!=='neutral'){
                  bubble.innerHTML='<span class="emotion-badge '+meta.emotion+'">'+meta.emotion+'</span><br>';
                }
                div.appendChild(avatar);div.appendChild(bubble);
                chatArea.appendChild(div);
                botBubble=bubble;
              }
              fullTokens+=ev.content;
              // Update with raw text during streaming
              const existingBadge=botBubble.querySelector('.emotion-badge');
              const badgeHtml=existingBadge?existingBadge.outerHTML+'<br>':'';
              botBubble.innerHTML=badgeHtml+'<span class="streaming-text">'+escHtml(fullTokens)+'</span>';
              scrollBottom();
            }else if(ev.type==='done'){
              // Replace with rendered markdown
              if(botBubble&&ev.full_response){
                const existingBadge2=botBubble.querySelector('.emotion-badge');
                const badgeHtml2=existingBadge2?existingBadge2.outerHTML+'<br>':'';
                botBubble.innerHTML=badgeHtml2+renderMarkdown(ev.full_response);
              }
              scrollBottom();
            }else if(ev.type==='error'){
              if(!botBubble)botBubble=addMessage('bot','');
              botBubble.innerHTML+='<br><span style="color:var(--danger)">Error: '+escHtml(ev.content)+'</span>';
            }
          }catch{}
        }
      }

      if(!botBubble){addMessage('bot','No response received.','neutral');}

    }catch(e){
      removeTyping();
      addMessage('bot','Connection error: '+e.message);
    }finally{
      isGenerating=false;
      sendBtn.disabled=false;
      msgInput.focus();
    }
  }
  window.sendMessage=sendMessage;
})();
</script>
</body>
</html>
